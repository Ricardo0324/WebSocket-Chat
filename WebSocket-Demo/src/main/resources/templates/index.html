<!DOCTYPE html>
<html lang="en">
<head>
    <script src="index.js" type="text/javascript"></script>
    <meta charset="UTF-8">
    <title>客户端</title>
    <base target="_blank">
</head>
<body>
<h1>客户端</h1><br/>
<a href="server.html" target="_blank">打开服务器页面</a>
<button onclick="buttonCreate()">与服务器建立websocket链接</button>
<button onclick="buttonClose()">关闭websocket链接</button>
<p>链接状态：</p>
<h1 id="status">未建立链接</h1>

<p>从服务器发来的信息：</p>
<h1 id="message"></h1>
<script>
    var websocket = null;

    var host = document.location.host;

    var userId = "${userId}"; // 获得当前登录人员的userName

    // alert(username)

    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        alert("浏览器支持Websocket")
        //假设当前用户是abc
        userId = 3;
        //alert(username);
        //alert('ws://'+host+'/webSocket/'+username);
    } else {
        alert('当前浏览器 Not support websocket')
    }


    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        document.getElementById('message').innerHTML += innerHTML + '<br/>';
    }

    //建立websocket链接
    function buttonCreate() {
        try {
            websocket = new WebSocket('ws://' + host + '/webSocket/' + userId);
            websocket.onopen=function(){
                console.log("websocket已经打开")
            }
            initWebSocket();
        }catch (e){
            alert(e);
        }
    }

    //关闭websocket链接
    function buttonClose() {
        try{
            websocket.close();
        }catch (e){
            alert(e)
        }
    }

    function initWebSocket() {

        //连接发生错误的回调方法
        websocket.onerror = function() {
            //alert("WebSocket连接发生错误")
            setMessageInnerHTML("WebSocket连接发生错误");

        };



        //连接成功建立的回调方法
        websocket.onopen = function() {
            //alert("WebSocket连接成功")
            changeStatus("WebSocket连接成功");
        }



        //接收到消息的回调方法
        websocket.onmessage = function(event) {
            //alert("这是后台推送的消息："+event.data);
            setMessageInnerHTML(event.data);
        }



        //连接关闭的回调方法
        websocket.onclose = function() {
            changeStatus("WebSocket连接关闭");
        }



        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function() {
            try {
                websocket.close();
            }catch (e){
                alert(e);
            }
        }
    }

    function changeStatus(text) {
        document.getElementById("status").innerText = text;
    }
</script>
</body>
</html>